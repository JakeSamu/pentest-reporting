from automation.const import *

criticality_color_dict_en = {
    "critical": "criticalcolor",
    "high": "highcolor",
    "medium": "mediumcolor",
    "low": "lowcolor",
    "info": "infocolor",
    "informational": "infocolor",
}
criticality_dict_en = {
    "critical": 9.5,
    "high": 8.0,
    "medium": 5.5,
    "low": 2.5,
    "info": 0.0,
    "informational": 0.0
}

criticality_color_dict_de = {
    "kritisch": "criticalcolor",
    "hoch": "highcolor",
    "mittel": "mediumcolor",
    "gering": "lowcolor",
    "informativ": "infocolor"
}
criticality_dict_de = {
    "kritisch": 9.5,
    "hoch": 8.0,
    "mittel": 5.5,
    "gering": 2.5,
    "informativ": 0.0
}

def criticality_to_color(criticality):
    if criticality.lower() in list(criticality_color_dict_de):
        return criticality_color_dict_de[criticality.lower()]
    else: return "black"

def criticality_to_cvss(criticality):
    if criticality.lower() in list(criticality_dict_de):
        return criticality_dict_de[criticality.lower()]
    else: return "n/a"
    
def cvss_to_criticality(cvss):
    if cvss >= 9.0: return "Kritisch"
    elif cvss >= 7.0: return "Hoch"
    elif cvss >= 4.0: return "Mittel"
    elif cvss > 0.0: return "Gering"
    else: return "Informativ"


class Finding:
    def __init__(self):
        self.title = "empty"
        self.label = "empty"
        self.criticality = "empty"
        self.cvss_value = float(0.0)
        self.cvss_vector = "empty"
        self.assets = "empty"
        self.description = "empty"
        self.poc = "empty"
        self.recommendation = "empty"
        self.latex_color = "empty"
        self.original_filepath = "empty"
        self.original_modified = 0
    
    def __lt__(self, other):
        # define it that way, such that the first entry has highest cvss value
        return self.cvss_value > other.cvss_value
    
    def __init__(self, markdownfile):
        if not markdownfile.endswith(".md"):
            print("Error: Given file "+markdownfile+" is not a markdown file.")
            exit(0)
        mdf = open(markdownfile, "r", encoding="utf-8")
        content = mdf.read()
        mdf.close()
        
        self.title = re.findall(r'(?:^|\s)# ([\s\S]*?)\n', content)[0]
        self.label = self.title
        
        parts = re.findall(r'\n## ([\s\S]*?)\n([\s\S]*?)(?=(?:\n##|\n# |$))', content)
        
        rating = parts[0][1]
        rating_entries = re.findall(r': ([\s\S]*?)(?=(?:\n|$))', rating)
        if len(rating_entries) != 3:
            print("Error in file \""+markdownfile+"\": the amount of rating entries is not correct")
            exit(0)
        self.criticality = rating_entries[0]
        try:
            self.cvss_value = float(rating_entries[1])
        except:
            print("Error in file \""+markdownfile+"\": the cvss-value "+rating_entries[1]+" is not a number.")
            exit(0)
        
        self.cvss_vector = rating_entries[2]
        self.assets = parts[1][1]
        self.description = parts[2][1]
        self.poc = parts[3][1]
        self.recommendation = parts[4][1]
        if self.criticality.lower() not in criticality_dict_de:
            print("Error in file \""+markdownfile+"\": criticality not found in language directory - default taken from cvss value")
            self.criticality = cvss_to_criticality(self.cvss_value)
        elif self.cvss_value < 0.0 or self.cvss_value > 10.0:
            print("Error in file \""+markdownfile+"\": cvss value out of bound - default taken from criticality")
            self.cvss_value = criticality_to_cvss(self.criticality)
        self.latex_color = criticality_to_color(self.criticality)

        self.original_filepath = markdownfile
        
        self.original_modified = os.path.getmtime(markdownfile)
    
    def convert_to_latex(self):
        import sys
        sys.path.append(os.path.dirname(os.path.realpath(__file__)))
        import automation.latex_conversion.converter.md2latex.md2latex as md2latex
        self.title = md2latex.string_to_string(self.title)
        self.label = md2latex.delete_latex_specialcharacters(self.label)
        self.assets = md2latex.string_to_string(self.assets)
        self.description = md2latex.string_to_string(self.description)
        self.poc = md2latex.string_to_string(self.poc)
        self.recommendation = md2latex.string_to_string(self.recommendation)

def main ():
    print("do not call the main function but every command by itself")

if __name__ == "__main__":
    main()
