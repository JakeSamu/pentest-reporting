from math import ceil
from automation.latex_conversion.converter.md_finding_extractor import *
from automation.const import *

findingconverteddir = os.path.join("template","findings","automated","markdown-to-latex")
findingdirpath = os.path.join("usersection","findings")

latex_finding_template = open(os.path.join("automation","latex_conversion","converter","defaults","finding.tex"), "r", encoding="utf-8")
latex_finding_template_content = latex_finding_template.read()
latex_finding_template.close()


def drawdiagram(finding_by_category):
    # file for writing
    latex_diagram_overview = open(os.path.join("template","management","automated","diagramm.tex"), "w", encoding="utf-8")
    latex_diagram_overview_content = GENERATEDFILE

    # pre computation for diagram needed
    i = 1
    amount_categories = len(list(finding_by_category))
    maxfinding_by_category = finding_by_category[max(finding_by_category, key=finding_by_category.get)]
    latex_diagram_overview_content += "\drawdiagram{"+str(ceil(maxfinding_by_category/3)*3+0.5)+"}{\n"
    # horizontal helping lines - yes or no?
    helplinesteps = ceil(maxfinding_by_category / 6)
    latex_diagram_overview_content += "\\drawhelplines{"+str(ceil(maxfinding_by_category/3)*3/helplinesteps)+"}{"+str(helplinesteps)+"}\n"

    # now draw one rectangle per category
    for category in finding_by_category:
        latex_diagram_overview_content += "\t\\drawbar{"+str(amount_categories)+"}{"+str(i)+"}{"+str(finding_by_category[category])+"}{"+criticality_to_color(category)+"}{"+category+"}"
        latex_diagram_overview_content += "\n"
        i += 1
    latex_diagram_overview_content += "}"
    latex_diagram_overview.write(latex_diagram_overview_content)
    latex_diagram_overview.close()


def write_latex_finding_if_not_modified(finding : Finding, filepath):
    # only write the file if it does not already exist (which means not modified)
    if not os.path.exists(filepath):
        file = open(filepath, "w", encoding="utf-8")

        # first write the template to output, then replace the variables

        output = GENERATEDFILE + latex_finding_template_content
        output = output.replace("$finding.title$", finding.title)
        output = output.replace("$finding.label$", finding.label)
        output = output.replace("$finding.latex_color$", finding.latex_color)
        output = output.replace("$finding.criticality$", finding.criticality)
        output = output.replace("$finding.cvss_value$", str(finding.cvss_value))
        output = output.replace("$finding.cvss_vector$", finding.cvss_vector)
        output = output.replace("$assets$", finding.assets)
        output = output.replace("$description$", finding.description)
        output = output.replace("$poc$", finding.poc)
        output = output.replace("$recommendation$", finding.recommendation)

        file.write(output)
        file.close()

def remove_modified_latexfiles():
    modified_list_file = open(os.path.join("template","findings","automated","modified.lst"), "r", encoding="utf-8")
    modified_list = modified_list_file.read().split("\n")
    modified_list_file.close()
    
    modified_dict = {}
    for line in modified_list:
        if len(line) > 3:
            modified_dict[line.split(", ")[0]] = line.split(", ")[1]
    
    for oldfinding in os.listdir(findingconverteddir):
        md_file = os.path.join("usersection","findings",oldfinding[:-3]+"md")
        try:
            last_changed = str(os.path.getmtime(md_file))
        except:
            last_changed = None
        if md_file in modified_dict:
            if modified_dict[md_file] == last_changed:
                continue
        os.remove(os.path.join(findingconverteddir,oldfinding))


def grab_findings ():
    run_script("findinggrabber")
    # prepare the files we will write to
    findings_latex_list = open(os.path.join("template","findings","automated","findingslist.tex"), "w", encoding="utf-8")
    findings_latex_list_content = GENERATEDFILE

    latex_table_overview = open(os.path.join("template","management","automated","tabelle.tex"), "w", encoding="utf-8")
    latex_table_overview_content = GENERATEDFILE
    
    # this we need for the diagram
    # todo: use file language
    category_bucket = {
        "Kritisch": 0,
        "Hoch": 0,
        "Mittel": 0,
        "Gering": 0,
        "Informativ": 0
    }
    
    # delete all pre-existing latex files that were modified
    # grab and prepare everything needed for looking up if some files need to be changed
    remove_modified_latexfiles()
    modified_list_content = ""
    modified_list_file = open(os.path.join("template","findings","automated","modified.lst"), "w", encoding="utf-8")
    
    # go through all findings and save every one in a list, then sort it by cvss value (first entry highest cvss value)
    findings = []
    for file in os.listdir(findingdirpath):
        if file.endswith(".md"):
            finding_file = os.path.join(findingdirpath,file)
            findings.append(Finding(finding_file))
    findings.sort()
    
    for finding in findings:
        # convert for latex
        finding.convert_to_latex()
        # define the latex file
        latex_filename = finding.original_filepath.split("\\")[-1][:-2] + "tex"
        latex_file_path = os.path.join(findingconverteddir,latex_filename)
        # write the latex file and save it, if it was not modified
        write_latex_finding_if_not_modified(finding, latex_file_path)

        # input the latex file for the report
        latex_in = "include"
        if finding == findings[0]:
            latex_in = "input"
        findings_latex_list_content += "\\"+latex_in+"{"+latex_file_path[:-4].replace("\\","/")+"}\n"

        # grab all the information for the table overview
        latex_table_overview_content += " & ".join(("\\ref{"+finding.label+"}","\hyperref["+finding.label+"]{"+finding.title+"}", str(finding.cvss_value), finding.criticality+"\\tabularnewline\n"))

        # add to the corresponding bucket for drawing purpose
        if finding.criticality not in category_bucket:
            category_bucket[finding.criticality] = 1
        else:
            category_bucket[finding.criticality] += 1
        
        modified_list_content += finding.original_filepath + ", " + str(finding.original_modified) + "\n"
    
    drawdiagram(category_bucket)
    
    findings_latex_list.write(findings_latex_list_content)
    findings_latex_list.close()
    latex_table_overview.write(latex_table_overview_content)
    latex_table_overview.close()

    modified_list_file.write(modified_list_content)
    modified_list_file.close()

if __name__ == "__main__":
    grab_findings()