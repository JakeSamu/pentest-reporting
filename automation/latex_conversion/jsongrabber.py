from automation.const import *


specificspath = os.path.join("template","pentestinfo","specifics")
tableitem = {
    "testumfang": "\t\\testumfangitem{$item1$}{$item2$}",
    "pentestsetup": "\t\\pentestsetupitem{$item1$}{$item2$}",
}

command_list = []

# command for setting a normal LaTeX macro
def writeLatexCommand(name, value):
    command_list.append(name)
    return "\\newcommand{\\"+name+"}" + "{"+value+"}\n"


# have a nice and clean setup, where old files will be deleted
def specificscleanup():
    for file in os.listdir(specificspath):
        if "pentestsetup" in file or "testumfang" in file:
            os.remove(os.path.join(specificspath,file))

# The folder "template > pentestinfo" contains a folder specifics, which we need to write data from the json objects. This is both the pentestsetup and testumfang. This function defines those specifics, primarily it is a convertion from specific json files inside a LaTeX-table.
def setspecifics(type, data, setuporumfang):
    file = os.path.join(specificspath,setuporumfang+"_"+type+".tex")
    testumfang = open(file, "w", encoding="utf-8")
    output = GENERATEDFILE

    defaultsfile = open(os.path.join("template","pentestinfo","defaults",setuporumfang+"_default.tex"), "r", encoding="utf-8")
    tableread = defaultsfile.read()
    defaultsfile.close()
    tableinput = ""

    for tool in data:
        if isinstance(data[tool], str):
            item1 = tool
            item2 = data[tool]
            match = re.search(r'(http:\/\/.*|https:\/\/.*)(?!\S)', item2)
            if match: item2 = "\\url{"+item2+"}"

            tableinput += tableitem[setuporumfang].replace("$item1$", item1).replace("$item2$", item2) + "\n"
    
    output += tableread.replace("$input$", tableinput[:-1])
    testumfang.write(output)
    testumfang.close()

# Here we write into the automated folder of pentestinfo, which files inside the folder specifics we want to use.
def setautomated_for_specifics(filename):
    file = os.path.join("template","pentestinfo","automated",filename+"_automated.tex")
    fileautomated = open(file, "w", encoding="utf-8")
    output = GENERATEDFILE
    
    for specificfile in os.listdir(specificspath):
        if filename in specificfile:
            output += "\\input{template/pentestinfo/specifics/"+specificfile+"}\n"
    
    fileautomated.write(output)
    fileautomated.close()

# Here we call the above functions with the correct parameter
def setscope(scopedata):
    specificscleanup()
    for scopetype in scopedata:
        if isinstance(scopedata[scopetype], dict):
            if len(scopedata[scopetype]["umfang"]) > 0:
                setspecifics(scopetype, scopedata[scopetype]["umfang"], "testumfang")
                setspecifics(scopetype, scopedata[scopetype]["setup"], "pentestsetup")
    setautomated_for_specifics("pentestsetup")
    setautomated_for_specifics("testumfang")

# Inside the specifcs folder of pentestinfo we have a set of files that present the general idea and workflow for the corresponding testing method (pentest, security analysis, assessment, etc). This is defined here
def setvorgehen(method):
    file = os.path.join("template","pentestinfo","automated","vorgehen_automated.tex")
    vorgehen = open(file, "w", encoding="utf-8")
    output = "% this is automagically generated\n"
    output += "\\input{template/pentestinfo/specifics/vorgehen_"+method+".tex}"
    vorgehen.write(output)
    vorgehen.close()

# Call the above function and also set the LaTeX command "\testmethod" to correct value. We currently believe that only one method is used for one report at a time.
def settestmethod(testmethodsdata):
    output = ""
    for method in testmethodsdata:
        if testmethodsdata[method]:
            output = method
            setvorgehen(method)
            break
    if output == "":
        print("Please check one of the test methods as true. Defaulting to pentest.")
        output = writeLatexCommand("testmethod", "\\pentest")
    else: output = writeLatexCommand("testmethod", "\\"+method)
    return output

# The main loop to extract and cool json data.
def convertjson_to_command(jsondata):
    output = ""
    for name in jsondata:
        if name == "scope":
            setscope(jsondata[name])
        elif name == "testmethods":
            output += settestmethod(jsondata[name])
        elif "comment_" not in name:
            if isinstance(jsondata[name], str):
                output += writeLatexCommand(name, jsondata[name])
            elif isinstance(jsondata[name], dict):
                output += convertjson_to_command(jsondata[name])
#            elif isinstance(jsondata[name], bool):
#                print(name, jsondata[name])
    return output

def history(jsonhistory):
    history = "\\newcommand{\\versionhistory}[0]{\n"
    for entry in jsonhistory:
        if "comment_" in entry: continue
        wrapin = []
        wrapin.append(entry)
        wrapin.append(jsonhistory[entry]["date"])
        wrapin.append(jsonhistory[entry]["reason"])
        wrapper = f"\\historyentry{{{wrapin[0]}}}{{{wrapin[1]}}}{{{wrapin[2]}}}\n"
        history += wrapper
    history += "}"
    
    historyfile = open(os.path.join("template","titlepage","history.tex"), "w", encoding="utf-8")
    historyfile.write(history)
    historyfile.close()


# Grab all the json files and insert their data into the above function.
def grab_json():
    run_script("jsongrabber")
    # get all json files
    jsondir = os.path.join("usersection", "variables")
    json_files = os.listdir(jsondir)

    output_file = open(os.path.join("template","macros","automated","commands_automated.tex"), "w", encoding="utf-8")
    output = "% this is automagically generated\n"

    for file in json_files:
        if not file.endswith(".json"): continue
        j = open(os.path.join(jsondir,file), "r", encoding="utf-8")
        jsondata = json.load(j)
        if file == "history.json":
            history(jsondata)
        else:
            output += "% " + file + "\n"
            output += convertjson_to_command(jsondata)
            output += "\n"
    output_file.write(output)
    output_file.close()

    command_list_file = open(os.path.join("automation","latex_conversion","integrity_checker","commandlist.lst"), "w", encoding="utf-8")
    command_list_file.write("\n".join(command_list))
    command_list_file.close()


if __name__ == "__main__":
    grab_json()