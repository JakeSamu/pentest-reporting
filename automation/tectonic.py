import os
import platform

TECTONIC_PATH = "automation"
TECTONIC_FILE = {
    "Windows": "tectonic.exe",
    "Linux": "tectonic",
    "Darwin": "tectonic"
}
LOGS = "logs"

def write_document(only_findings, only_management):
    d = open(os.path.join("template","document.tex"), "w", encoding="utf-8")
    d_writer = "% this is automagically generated\n"
    
    if only_findings:
        d_writer += "\\input{template/document-findings-only.tex}"
    else:# meaning args.full, since this is the default
        if only_management:
            d_writer += "\\input{template/document-management-only.tex}"
        else:
            d_writer += "\\input{template/document-full.tex}"
    d.write(d_writer)
    d.close()


def cleanup(filename):
    print("\n### cleaning up logs")
    for direlement in os.listdir("."):
        if direlement.startswith(filename[:-4]) and not (direlement.endswith(".pdf") or direlement.endswith(".tex")):
            os.replace(direlement, os.path.join(LOGS, direlement))
    print("Done.")

def tectonic(args):
    for direlement in os.listdir("."):
        if direlement.endswith(".tex"):
            filename = direlement
            break
    
    tectonic = os.path.join(TECTONIC_PATH, TECTONIC_FILE[platform.system()])
    print("\n### Compiling with tectonic ...")
    try:
        os.system(tectonic+" "+filename+" --synctex --keep-logs")
        if args.output_name is not None:
            os.rename(filename[:-4]+".pdf", args.output_name+".pdf")
    except:
        exit("Error occured while compiling with tectonic, please look at report.log or above error message for further details.")
    cleanup(filename)


def compile(args):
    # change the template corresponding to args input
    write_document(args.only_findings, args.only_management)
    # compile tectonic
    tectonic(args)

