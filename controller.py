import argparse
from automation.const import *


def argparser():
    parser = argparse.ArgumentParser(description="Automater for LaTeX Pentest Reporting")

    pdf = parser.add_argument_group("restricting pdf content")
    pdf.add_argument("--full", help="pdf will have everything, this is the default", action="store_true")
    pdf.add_argument("--only-findings", help="pdf will only have the overview of the findings and nothing else", action="store_true")
    pdf.add_argument("--only-management", help="pdf will only have the management-section", action="store_true")
    
    scripts = parser.add_argument_group("call specific scripts")
    scripts.add_argument("-t", "--tectonic-only", help="set this flag if you only want to run tectonic / build the pdf", action="store_true")
    scripts.add_argument("-a", "--automation-only", help="set this flag if you only want to run the python scripts and do not build the pdf", action="store_true")
    
    useability = parser.add_argument_group("userfriendly options")
    useability.add_argument("-o", "--output-name", help="rename the pdf to the given string", type=str)
    useability.add_argument("-r", "--restart-project", help="delete all findings, everything inside appendix, the content of the management-files and reset history", action="store_true")
    #useability.add_argument("--reset-full", help="same as --restart-project plus remove everything user-specific in the json files", action="store_true")
    
    #plugins = parser.add_argument_group("call specific plugins")
    #plugins.add_argument("--scanner-tls", help="start testssl.sh and scan all active ips and urls in scope.json", action="store_true")

    return parser.parse_args()


def main ():
    args = argparser()
    
    try:
        if args.restart_project:
            import automation.reset
            automation.reset.restart()
            exit(True)
    except:
        exit("Some error occured by restarting the project, ending controller.")

    # call all python scripts
    try:
        if not args.tectonic_only:
            import automation.scripthandler
            automation.scripthandler.prepare(args)
    except:
        exit("Some error occured during one of the scripts, ending controller. For more details, start the last namend script on its own.")
    
    # use tectonic to compile pdf file and clean up the logs
    try:
        if not args.automation_only:
            import automation.tectonic
            automation.tectonic.compile(args)
    except:
        exit("Some error occured during LaTeX compilation, ending controller.")


if __name__ == '__main__':
    main()
